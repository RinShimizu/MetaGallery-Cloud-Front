<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.js"></script> <!-- 引入 crypto-js -->
    <link rel="icon" href="云盘.svg" type="image/x-icon">
    <title>个人主页</title>
    <style>
        /* 设置页面背景颜色为白色 */
        body {
            background-color: #ffffff; /* 白色 */
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100vh; /* 让 body 占满整个视窗高度 */
            display: flex;
            flex-direction: column; /* 使内容垂直排列 */
            align-items: center; /* 内容水平居中 */
            position: relative; /* 使子元素可以绝对定位 */
        }

        /* 悬浮框样式 */
        .floating-box {
            display: none; /* 初始不显示 */
            position: absolute; /* 绝对定位 */
            top: 100px; /* 悬浮框顶部距离 */
            right: 30px; /* 悬浮框右侧距离 */
            width: 150px; /* 悬浮框宽度 */
            padding: 10px; /* 内边距 */
            background-color: white; /* 背景颜色 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* 阴影效果 */
            border-radius: 10px; /* 圆角 */
            z-index: 1000; /* 确保在最上层 */
        }

        .floating-box button {
            width: 100%; /* 按钮宽度 */
            padding: 10px; /* 按钮内边距 */
            border: none; /* 无边框 */
            border-radius: 5px; /* 圆角 */
            background-color: #007bff; /* 按钮背景颜色 */
            color: white; /* 按钮文字颜色 */
            cursor: pointer; /* 鼠标样式 */
        }

        /* 顶部空白框样式 */
        .top-box {
            width: 100%; /* 与页面一样宽 */
            height: 80px; /* 高度 */
            background-color: #ffffff; /* 背景色 */
            display: flex; /* 使内容可居中 */
            align-items: center; /* 内容垂直居中 */
            justify-content: space-between; /* 内容两端对齐 */
            padding: 0 20px; /* 左右内边距 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 阴影效果 */
        }

        /* 顶部图标样式 */
        .top-icon {
            width: 200px; /* 图标宽度 */
            height: 50px; /* 图标高度 */
        }

        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear {
            display: none;
        }
        /* 右侧小图标容器样式 */
        .small-icons {
            display: flex; /* 使小图标水平排列 */
            align-items: center; /* 垂直居中 */
            margin-right: 50px; /* 距离右边界10px */
        }

        /* 小图标样式 */
        .small-icon {
            width: 50px; /* 小图标宽度 */
            height: 50px; /* 小图标高度 */
            margin-left: 100px; /* 小图标间距 */
        }

        /* 空白框样式 */
        .box {
            width: 900px; /* 框宽度 */
            height: 550px; /* 框高度 */
            background-color: #f3fbfe; /* 框背景色 */
            border-radius: 20px; /* 圆角半径 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* 阴影效果 */
            display: flex; /* 使内容可居中 */
            justify-content: flex-start; /* 内容左对齐 */
            align-items: flex-start; /* 内容顶部对齐 */
            position: relative; /* 使图标和文本相对于框定位 */
            margin-top: 80px; /* 与顶部框的间距 */
            padding: 20px; /* 内边距 */
        }

        /* 图标样式 */
        .icon {
            position: absolute; /* 绝对定位 */
            top: -40px; /* 距离框顶部20像素 */
            left: 20px; /* 距离左边20像素 */
            width: 40px; /* 图标宽度 */
            height: 40px; /* 图标高度 */
        }

        /* 文本样式 */
        .text {
            position: absolute; /* 绝对定位 */
            top: -40px; /* 距离框顶部，保持与图标对齐 */
            left: 70px; /* 距离左边70像素，保证与图标有间距 */
            font-size: 23px; /* 字体大小 */
            color: #7e7b7b; /* 字体颜色 */
        }

        /* 输入框容器样式 */
        .input-container {
            margin-left: 500px; /* 调整输入框的左侧位置 */
            margin-top: 50px; /* 输入框与顶部的间距 */
            display: flex; /* 使输入框和标签在同一行 */
            flex-direction: column; /* 竖排 */
            align-items: flex-end; /* 右对齐 */
        }

        /* 输入框样式 */
        .input {
            width: 300px; /* 输入框宽度 */
            height: 30px; /* 输入框高度 */
            border-radius: 15px; /* 圆角半径 */
            border: 1px solid #ccc; /* 边框 */
            margin-bottom: 30px; /* 输入框之间的间距 */
            padding: 5px; /* 内边距 */
        }

        /* 标签样式 */
        .label {
            display: flex; /* 使标签和输入框并排 */
            align-items: center; /* 垂直居中 */
            margin-bottom: 10px; /* 标签与输入框之间的间距 */
        }

        /* 账号部分样式 */
        .account-label {
            position: absolute; /* 绝对定位 */
            top: 320px; /* 距离框顶部 */
            left: 150px; /* 距离框左侧 */
            font-size: 18px; /* 字体大小 */
            color: #7e7b7b; /* 字体颜色 */
        }

        /* 修改 accountAvatarImage 的样式 */
        //#accountAvatarImage {
        //    position: absolute; /* 绝对定位 */
        //    top: 200px; /* 调整顶部位置 */
        //    left: 170px; /* 调整左侧位置 */
        //    width: 700px; /* 修改为所需宽度 */
        //    height: 700px; /* 修改为所需高度 */
        //    border-radius: 50%; /* 圆形头像 */
        //    //margin-bottom: 10px; /* 与下面元素的间距 */
        //}

        .avatar-image {
            position: absolute; /* 绝对定位 */
            top: 130px; /* 调整顶部位置 */
            left: 150px; /* 调整左侧位置 */
            width: 150px; /* 需要的宽度 */
            height: 150px; /* 需要的高度 */
            border-radius: 50%; /* 圆形头像 */
            margin-bottom: 10px; /* 与下面元素的间距 */
        }

        .account-value {
            position: absolute; /* 绝对定位 */
            top: 360px; /* 距离框顶部 */
            left: 100px; /* 距离框左侧 */
            width: 250px; /* 宽度 */
            height: 50px; /* 高度 */
            border-radius: 15px; /* 圆角半径 */
            border: 1px solid #ccc; /* 边框 */
            display: flex; /* 使内容可居中 */
            justify-content: center; /* 内容水平居中 */
            align-items: center; /* 内容垂直居中 */
            background-color: #ffffff; /* 背景色 */
        }

        /* 按钮样式 */
        .button {
            width: 100px; /* 按钮宽度 */
            height: 40px; /* 按钮高度 */
            border-radius: 15px; /* 圆角半径 */
            border: none; /* 无边框 */
            color: white; /* 字体颜色 */
            background-color: #007bff; /* 背景颜色 */
            margin-right: 40px; /* 按钮间距 */
        }

        /* 按钮容器样式 */
        .button-container {
            display: flex; /* 使按钮水平排列 */
            margin-top: 20px; /* 按钮与输入框的间距 */
        }

        /* 眼睛图标样式 */
        .toggle-password-btn {
            position: absolute;
            right: 10px; /* 调整到输入框的右边 */
            top: 5px; /* 调整图标的垂直位置 */
            cursor: pointer;
            font-size: 16px; /* 图标大小 */
            color: #aaa; /* 图标颜色 */
        }
    </style>
</head>
<body>
<div class="top-box">
    <img src="img1.png" alt="顶部图标" class="top-icon" />
    <div class="small-icons">
        <img src="small-icon1.svg" alt="小图标1" class="small-icon" />

        <img id="avatarImage" src="small-icon2.png" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; cursor: pointer;">
    </div>
</div>
<div class="box">
    <img src="img.png" alt="图标" class="icon" />
    <span class="text">个人中心</span> <!-- 添加的文本 -->

    <!-- 账号部分 -->
    <img id="accountAvatarImage" src="small-icon2.png" alt="Avatar" class="avatar-image"> <!-- 新增头像 -->
    <span class="account-label">账号：（不可修改）</span>
    <div class="account-value" id="accountValue">不可修改</div>

    <!-- 输入框部分 -->
    <div class="input-container">
        <div class="label">
            <span>昵称：</span>
            <input type="text" class="input" id="nickname" placeholder="如不修改昵称，此框可不写" />
        </div>
        <div class="label">
            <span>个性签名：</span>
            <input type="text" class="input" id="signature" placeholder="这个人很懒，什么都没有写~" />
        </div>
        <div class="label">
            <span>原密码：</span>
            <div style="position: relative;">
                <input type="password" class="input" id="oldpwd" placeholder="如不修改密码，此框可不写" />
                <span class="toggle-password-btn" onclick="togglePasswordVisibility('oldpwd', this)">👁️</span>
            </div>
        </div>
        <div class="label">
            <span>修改密码：</span>
            <div style="position: relative;">
                <input type="password" class="input" id="newpwd" placeholder="如不修改密码，此框可不写" />
                <span class="toggle-password-btn" onclick="togglePasswordVisibility('newpwd', this)">👁️</span>
            </div>
        </div>
        <div class="label">
            <span>确认密码：</span>
            <div style="position: relative;">
                <input type="password" class="input" id="confirmnewpwd" placeholder="如不修改密码，此框可不写" />
                <span class="toggle-password-btn" onclick="togglePasswordVisibility('confirmnewpwd', this)">👁️</span>
            </div>
        </div>

        <!-- 按钮部分 -->
        <div class="button-container">
            <button class="button" id="confirmButton">确认</button>
            <button class="button" id="cancelButton">取消</button>
        </div>
    </div>
</div>

<!-- 悬浮框 -->
<div class="floating-box" id="floatingBox">
    <button id="logoutButton">退出</button>
</div>

<script>

    function togglePasswordVisibility(inputId, iconElement) {
        const inputField = document.getElementById(inputId);
        if (inputField.type === "password") {
            inputField.type = "text"; // 将密码输入框改为可见
            iconElement.textContent = "👁️"; // 修改为可见图标
        } else {
            inputField.type = "password"; // 将密码输入框改为不可见
            iconElement.textContent = "🙈"; // 修改为隐私图标
        }
    }
    document.addEventListener("DOMContentLoaded", function () {

        // 设置密码输入框图标为 🙈
        const passwordInputs = ['oldpwd', 'newpwd', 'confirmnewpwd'];
        passwordInputs.forEach(inputId => {
            const inputField = document.getElementById(inputId);
            const iconElement = document.querySelector(`.toggle-password-btn[onclick*="${inputId}"]`);
            if (inputField) {
                inputField.type = "password"; // 确保输入框是不可见的
                if (iconElement) {
                    iconElement.textContent = "🙈"; // 设置图标为 🙈
                }
            }
        });

        // 显示悬浮框
        const avatarImage = document.getElementById('avatarImage');
        const floatingBox = document.getElementById('floatingBox'); // 确保有一个悬浮框的元素

        avatarImage.addEventListener('click', function () {
            // 切换悬浮框显示
            if (floatingBox.style.display === 'none' || floatingBox.style.display === '') {
                floatingBox.style.display = 'block'; // 显示悬浮框
            } else {
                floatingBox.style.display = 'none'; // 隐藏悬浮框
            }
        });

        // 退出按钮事件
        const logoutButton = document.getElementById('logoutButton');
        logoutButton.addEventListener('click', function () {
            // 这里可以执行退出逻辑，比如清除 token 等
            localStorage.removeItem('token'); // 示例：清除 token
            window.location.href = '../homepage.html'; // 跳转到上一个页面（替换为实际页面）
        });

        // 点击其他地方隐藏悬浮框
        document.addEventListener('click', function (event) {
            if (!avatarImage.contains(event.target) && !floatingBox.contains(event.target)) {
                floatingBox.style.display = 'none'; // 隐藏悬浮框
            }
        });

        // 从 localStorage 中读取 userData
        const userData = JSON.parse(localStorage.getItem('userData'));
        console.log("从 localStorage 读取到的数据:", userData);

        // const token = localStorage.getItem('token');
        // console.log("获取到的 token:", token);
        if (userData && userData.data && userData.data.userInfo) {
            // 获取嵌套的 userInfo
            const userInfo = userData.data.userInfo;

            // 获取要填充的元素
            const accountValueElement = document.getElementById('accountValue');
            const nicknameElement = document.getElementById('nickname');
            const signatureElement = document.getElementById('signature');
            const avatarImage = document.getElementById('avatarImage');
            const accountAvatarImage = document.getElementById('accountAvatarImage'); // 修改为新的 ID

            if (accountValueElement) {
                accountValueElement.textContent = userInfo.account || '不可修改';
                console.log("accountValue 填充成功:", userInfo.account);
            } else {
                console.error("accountValue 元素未找到");
            }

            if (nicknameElement) {
                nicknameElement.value = userInfo.name || '';
                console.log("nickname 填充成功:", userInfo.name);
            } else {
                console.error("nickname 元素未找到");
            }

            if (signatureElement) {
                signatureElement.value = userInfo.intro || '';
                console.log("signature 填充成功:", userInfo.intro);
            } else {
                console.error("signature 元素未找到");
            }
            if (avatarImage) {
                // 使用 userInfo.avatar 替换 small-icon2.png
                avatarImage.src = userInfo.avatar || 'small-icon2.png';
                console.log("头像已成功更新为:", userInfo.avatar);
            } else {
                console.error("找不到头像 img 元素");
            }
            if (accountAvatarImage) {
                // 使用 userInfo.avatar 替换 small-icon2.png
                accountAvatarImage.src = userInfo.avatar || 'small-icon2.png';
                console.log("头像已成功更新为:", userInfo.avatar);
            } else {
                console.error("找不到头像 img 元素");
            }

            // 确认按钮点击事件
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.addEventListener('click', function () {
                const oldPassword = document.getElementById('oldpwd').value; // 原密码
                const newPassword = document.getElementById('newpwd').value; // 修改密码
                const confirmPassword = document.getElementById('confirmnewpwd').value; // 确认密码

                if (oldPassword && newPassword && confirmPassword){
                    // 进行 SHA-256 加密
                    const encryptedoldPassword = CryptoJS.SHA256(oldPassword).toString(CryptoJS.enc.Base64);
                    const encryptednewPassword = CryptoJS.SHA256(newPassword).toString(CryptoJS.enc.Base64);
                    const encryptedconPassword = CryptoJS.SHA256(confirmPassword).toString(CryptoJS.enc.Base64);
                    const formData1 = new FormData();
                    formData1.append('account', userInfo.account); // 账号（不可修改）
                    formData1.append('old_password', encryptedoldPassword); // 原密码
                    formData1.append('new_password', encryptednewPassword); // 修改密码
                    formData1.append('confirm_password', encryptedconPassword);//确认密码

                    fetch('http://127.0.0.1:8080/api/updatePassword', {
                        method: 'POST', // 根据你的后端接口要求使用相应的 HTTP 方法
                        headers: {
                            //'Content-Type': 'application/json', // 发送 JSON 数据
                            'Authorization':  localStorage.getItem('token'), // 包含 Token
                        },
                        body: formData1, // 将更新的数据转为 JSON 字符串
                    })
                        .then(response => {
                            console.log('响应对象:', response);
                            if (!response.ok) {
                                throw new Error('网络响应不是 OK');
                            }
                            return response.json(); // 解析响应为 JSON
                        })
                        .then(data => {
                            console.log('成功:', data);
                            alert(data.msg)
                        })
                        .catch((error) => {
                            console.error('发生错误:', error);
                            // 在这里可以处理错误反馈，比如提示用户更新失败
                        });

                }
                const formData = new FormData();
                formData.append('account', userInfo.account); // 账号（不可修改）
                formData.append('name', document.getElementById('nickname').value); // 昵称
                formData.append('info', document.getElementById('signature').value); // 个性签名
                const nickname = document.getElementById('nickname').value;
                const signature = document.getElementById('signature').value;
                if(nickname!==userInfo.name||signature!==userInfo.intro){
                    // 使用 fetch 发送 POST 请求到 UpdateUserInfo 接口
                    fetch('http://127.0.0.1:8080/api/updateProfile', {
                        method: 'POST', // 根据你的后端接口要求使用相应的 HTTP 方法
                        headers: {
                            //'Content-Type': 'application/json', // 发送 JSON 数据
                            'Authorization':  localStorage.getItem('token'), // 包含 Token
                        },
                        body: formData, // 将更新的数据转为 JSON 字符串
                    })
                        .then(response => {
                            console.log('响应对象:', response);
                            if (!response.ok) {
                                throw new Error('网络响应不是 OK');
                            }
                            return response.json(); // 解析响应为 JSON
                        })
                        .then(data => {
                            console.log('成功:', data);
                            alert(data.msg)
                            if(data.status==='SUCCESS'){
                                //localStorage.setItem('userData', JSON.stringify(data));
                                userData.data.userInfo.name = nickname; // 更新昵称
                                userData.data.userInfo.intro = signature; // 更新个性签名
                                localStorage.setItem('userData', JSON.stringify(userData)); // 保存更新后的数据
                                console.log("localStorage 更新成功:", userData);
                            }
                        })
                        .catch((error) => {
                            console.error('发生错误:', error);
                            // 在这里可以处理错误反馈，比如提示用户更新失败
                        });
                }
                if (!oldPassword && !newPassword && !confirmPassword && nickname===userInfo.name && signature===userInfo.intro){
                    alert('您未作出任何修改！')
                }
            });

            // 取消按钮点击事件
            const cancelButton = document.getElementById('cancelButton');
            cancelButton.addEventListener('click', function (){
                location.reload(); // 重新加载页面
            });
        } else {
            console.error("用户数据未找到或数据格式不正确");
        }
    });

</script>
</body>
</html>
